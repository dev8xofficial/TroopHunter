- name: Apply Istio configuration
  command: kubectl apply -f kubernetes/istio/{{ ENVIRONMENT }}/
  args:
    chdir: /home/{{ USER }}/{{ PROJECT_NAME }}/{{ ENVIRONMENT }}/
  environment:
    KUBECONFIG: "/home/{{ USER }}/.kube/config"

- name: Apply Kubernetes manifests in all microservices
  command: kubectl apply -f kubernetes/k8s/{{ item }}/{{ ENVIRONMENT }}/
  args:
    chdir: /home/{{ USER }}/{{ PROJECT_NAME }}/{{ ENVIRONMENT }}/
  environment:
    KUBECONFIG: "/home/{{ USER }}/.kube/config"
  loop:
    - main
    - auth
    - countries
    - businesses
    - queues
    - users
